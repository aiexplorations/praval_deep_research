name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string

env:
  CARGO_TERM_COLOR: always

jobs:
  build-backend:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            target: x86_64-apple-darwin
            binary_name: praval-backend-x86_64-apple-darwin
          - os: macos-latest
            target: aarch64-apple-darwin
            binary_name: praval-backend-aarch64-apple-darwin
          - os: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            binary_name: praval-backend-x86_64-unknown-linux-gnu
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            binary_name: praval-backend-x86_64-pc-windows-msvc.exe

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install pyinstaller
          pip install -r requirements.txt
        shell: bash

      - name: Build backend binary (Unix)
        if: runner.os != 'Windows'
        run: |
          pyinstaller \
            --name praval-backend \
            --onefile \
            --console \
            --clean \
            --noconfirm \
            --add-data "src/agentic_research:agentic_research" \
            --hidden-import uvicorn \
            --hidden-import uvicorn.logging \
            --hidden-import uvicorn.loops.auto \
            --hidden-import uvicorn.protocols.http.auto \
            --hidden-import uvicorn.protocols.websockets.auto \
            --hidden-import uvicorn.lifespan.on \
            --hidden-import fastapi \
            --hidden-import starlette \
            --hidden-import pydantic \
            --hidden-import pydantic_settings \
            --hidden-import aiohttp \
            --hidden-import openai \
            --hidden-import anthropic \
            --hidden-import tiktoken \
            --hidden-import tiktoken_ext.openai_public \
            --hidden-import numpy \
            --hidden-import pandas \
            --hidden-import qdrant_client \
            --hidden-import structlog \
            --hidden-import httpx \
            --hidden-import praval \
            --hidden-import vajra_bm25 \
            --hidden-import langextract \
            --hidden-import ollama \
            --exclude-module matplotlib \
            --exclude-module scipy \
            --exclude-module torch \
            --exclude-module tensorflow \
            --exclude-module PIL \
            --exclude-module tkinter \
            src/agentic_research/api/embedded_main.py

      - name: Build backend binary (Windows)
        if: runner.os == 'Windows'
        run: |
          pyinstaller `
            --name praval-backend `
            --onefile `
            --console `
            --clean `
            --noconfirm `
            --add-data "src/agentic_research;agentic_research" `
            --hidden-import uvicorn `
            --hidden-import uvicorn.logging `
            --hidden-import uvicorn.loops.auto `
            --hidden-import uvicorn.protocols.http.auto `
            --hidden-import uvicorn.protocols.websockets.auto `
            --hidden-import uvicorn.lifespan.on `
            --hidden-import fastapi `
            --hidden-import starlette `
            --hidden-import pydantic `
            --hidden-import pydantic_settings `
            --hidden-import aiohttp `
            --hidden-import openai `
            --hidden-import anthropic `
            --hidden-import tiktoken `
            --hidden-import tiktoken_ext.openai_public `
            --hidden-import numpy `
            --hidden-import pandas `
            --hidden-import qdrant_client `
            --hidden-import structlog `
            --hidden-import httpx `
            --hidden-import praval `
            --hidden-import vajra_bm25 `
            --hidden-import langextract `
            --hidden-import ollama `
            --exclude-module matplotlib `
            --exclude-module scipy `
            --exclude-module torch `
            --exclude-module tensorflow `
            --exclude-module PIL `
            --exclude-module tkinter `
            src/agentic_research/api/embedded_main.py
        shell: pwsh

      - name: Rename binary
        run: |
          if [ "${{ runner.os }}" == "Windows" ]; then
            mv dist/praval-backend.exe dist/${{ matrix.binary_name }}
          else
            mv dist/praval-backend dist/${{ matrix.binary_name }}
          fi
        shell: bash

      - name: Upload backend binary
        uses: actions/upload-artifact@v4
        with:
          name: backend-${{ matrix.target }}
          path: dist/${{ matrix.binary_name }}

  build-tauri:
    needs: build-backend
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            target: x86_64-apple-darwin
            backend_binary: praval-backend-x86_64-apple-darwin
          - os: macos-latest
            target: aarch64-apple-darwin
            backend_binary: praval-backend-aarch64-apple-darwin
          - os: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            backend_binary: praval-backend-x86_64-unknown-linux-gnu
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            backend_binary: praval-backend-x86_64-pc-windows-msvc.exe

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Rust
        uses: dtolnay/rust-action@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf

      - name: Download backend binary
        uses: actions/download-artifact@v4
        with:
          name: backend-${{ matrix.target }}
          path: desktop/src-tauri/binaries/

      - name: Make backend binary executable
        if: runner.os != 'Windows'
        run: chmod +x desktop/src-tauri/binaries/${{ matrix.backend_binary }}

      - name: Install frontend dependencies
        working-directory: frontend-new
        run: npm ci

      - name: Build frontend
        working-directory: frontend-new
        run: npm run build

      - name: Install Tauri dependencies
        working-directory: desktop
        run: npm ci

      - name: Build Tauri app (macOS x64)
        if: matrix.target == 'x86_64-apple-darwin'
        working-directory: desktop
        run: npm run tauri build -- --target x86_64-apple-darwin
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}

      - name: Build Tauri app (macOS ARM)
        if: matrix.target == 'aarch64-apple-darwin'
        working-directory: desktop
        run: npm run tauri build -- --target aarch64-apple-darwin
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}

      - name: Build Tauri app (Linux)
        if: runner.os == 'Linux'
        working-directory: desktop
        run: npm run tauri build
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}

      - name: Build Tauri app (Windows)
        if: runner.os == 'Windows'
        working-directory: desktop
        run: npm run tauri build
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}

      - name: Upload macOS DMG
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg-${{ matrix.target }}
          path: desktop/src-tauri/target/*/release/bundle/dmg/*.dmg

      - name: Upload Linux AppImage
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage
          path: desktop/src-tauri/target/release/bundle/appimage/*.AppImage

      - name: Upload Linux deb
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: linux-deb
          path: desktop/src-tauri/target/release/bundle/deb/*.deb

      - name: Upload Windows MSI
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: windows-msi
          path: desktop/src-tauri/target/release/bundle/msi/*.msi

      - name: Upload Windows NSIS
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: windows-nsis
          path: desktop/src-tauri/target/release/bundle/nsis/*.exe

  release:
    needs: build-tauri
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display artifacts
        run: find artifacts -type f | head -50

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Praval Deep Research v${{ steps.version.outputs.version }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            artifacts/**/*.dmg
            artifacts/**/*.AppImage
            artifacts/**/*.deb
            artifacts/**/*.msi
            artifacts/**/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
